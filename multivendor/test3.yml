---
- name: Multi-vendor network backups (Cisco / Juniper / Arista / Aruba / Extreme)
  hosts: all
  gather_facts: no

  vars:
    backup_root: "{{ playbook_dir }}/backups"
    run_ts: "{{ lookup('pipe','date +%Y%m%d-%H%M%S') }}"
    run_dir: "{{ backup_root }}/{{ run_ts }}"

  pre_tasks:
    - name: Create backup run directory on control node (once)
      ansible.builtin.file:
        path: "{{ run_dir }}"
        state: directory
        mode: "0755"
      delegate_to: localhost
      run_once: true

  tasks:
    # -------------------------
    # Cisco IOS
    # -------------------------
    - name: Cisco - backup running-config
      when: inventory_hostname in groups.get('cisco', [])
      block:
        - name: Collect running-config
          cisco.ios.ios_command:
            commands:
              - show running-config
          register: cisco_out

        - name: Write Cisco backup file
          ansible.builtin.copy:
            dest: "{{ run_dir }}/{{ inventory_hostname }}_cisco_running.cfg"
            content: "{{ cisco_out.stdout[0] }}\n"
            mode: "0644"
          delegate_to: localhost

    # -------------------------
    # Juniper Junos
    # -------------------------
    - name: Juniper - backup configuration (display set)
      when: inventory_hostname in groups.get('juniper', [])
      block:
        - name: Collect config (display set)
          juniper.device.command:
            commands:
              - show configuration | display set | no-more
          register: jun_out

        - name: Write Juniper backup file
          ansible.builtin.copy:
            dest: "{{ run_dir }}/{{ inventory_hostname }}_juniper_display_set.conf"
            content: "{{ jun_out.stdout[0] }}\n"
            mode: "0644"
          delegate_to: localhost

    # -------------------------
    # Arista EOS
    # -------------------------
    - name: Arista - backup running-config
      when: inventory_hostname in groups.get('arista', [])
      block:
        - name: Collect running-config
          arista.eos.eos_command:
            commands:
              - show running-config
          register: arista_out

        - name: Write Arista backup file
          ansible.builtin.copy:
            dest: "{{ run_dir }}/{{ inventory_hostname }}_arista_running.cfg"
            content: "{{ arista_out.stdout[0] }}\n"
            mode: "0644"
          delegate_to: localhost
